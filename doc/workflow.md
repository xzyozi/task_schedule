-----

## ワークフロー機能追加 改造仕様書

### 1. 概要

#### 1.1. 背景

現在のタスクスケジューラは、個々のタスク（Job）をスケジュール実行する機能を持つが、複数のタスクを決められた順序で実行するような、より複雑な自動化シナリオには対応していない。

#### 1.2. 目的

本改造の目的は、複数のステップから成る**「ワークフロー」**を定義・管理し、順次実行する機能を新たに導入することである。これにより、データ処理バッチやCI/CDパイプラインのような、一連の連続した処理を自動化することが可能になる。

-----

### 2. アーキテクチャ

#### 2.1. 全体構成

既存のジョブ実行エンジン（APScheduler）を最大限に活用する。ワークフロー全体を一つの特殊なPythonジョブ（`run_workflow`）としてAPSchedulerに登録する。このジョブがトリガーされると、ワークフローに定義された各ステップを順次実行する。

#### 2.2. コンポーネントの役割

*   **APScheduler**: ワークフロー全体の起動トリガー（タイマー）として機能する。
*   **`run_workflow` (Python Job)**: ワークフロー実行の心臓部。APSchedulerから呼び出され、以下の処理を行う。
    1.  担当するワークフローの定義とステップ一覧をデータベースから取得する。
    2.  `workflow_runs`テーブルに今回の実行インスタンスを記録する。
    3.  ステップを`step_order`に従って一つずつ順番に実行する。
    4.  各ステップの実行結果（成功/失敗）を`ProcessExecutionLog`に記録し、`workflow_runs`のステータスを更新する。
    5.  ステップが失敗した場合、`on_failure`の定義に従い、ワークフローを停止または継続する。

-----

### 3. データベース設計

ワークフローの定義と実行状態を永続化するため、新たに3つのテーブルを追加する。

#### 3.1. 新規テーブル定義

1.  **`workflows` テーブル**
    | カラム名 | 型 | 説明 |
    | :--- | :--- | :--- |
    | `id` | Integer | 主キー |
    | `name` | String | ワークフロー名 |
    | `description` | Text | ワークフローの説明 |
    | `schedule` | String | 実行スケジュール（Cron形式など） |
    | `is_enabled` | Boolean | 有効フラグ |

2.  **`workflow_steps` テーブル**
    | カラム名 | 型 | 説明 |
    | :--- | :--- | :--- |
    | `id` | Integer | 主キー |
    | `workflow_id` | Integer | `workflows`テーブルへの外部キー |
    | `step_order` | Integer | ステップの実行順序 |
    | `name` | String | ステップ名 |
    | `job_type` | String | `shell`, `cmd`, `powershell`, `python` |
    | `target` | Text | 実行するコマンドや関数パス |
    | `args` | JSON | コマンドへの引数リスト |
    | `kwargs` | JSON | キーワード引数 |
    | `on_failure`| String | 失敗時の挙動 (`stop`, `continue`) |
    | `timeout`| Integer | タイムアウト秒数 |

3.  **`workflow_runs` テーブル**
    | カラム名 | 型 | 説明 |
    | :--- | :--- | :--- |
    | `id` | Integer | 主キー |
    | `workflow_id` | Integer | `workflows`テーブルへの外部キー |
    | `status` | String | `RUNNING`, `COMPLETED`, `FAILED` |
    | `current_step`| Integer | 現在実行中のステップ番号 |
    | `start_time` | DateTime | ワークフロー開始時刻 |
    | `end_time` | DateTime | ワークフロー終了時刻 |

-----

### 4. UI/UX設計

#### 4.1. 画面設計

ワークフローの作成・編集は、サイドバーに「ワークフロー管理」メニューを新設し、専用画面で行う。UIの構成は当初の仕様書案を踏襲する。

```plaintext
======================================================================
【ワークフロー新規作成】
======================================================================
[基本情報]
----------------------------------------------------------------------
ワークフロー名: [ (テキスト入力) ]
説　　明: 　　　[ (テキストエリア) ]
スケジュール: 　 [ Cron形式: [ 0 3 * * * ] ]

---
[ステップ定義]
----------------------------------------------------------------------
 [ステップ1] --------------------------------------------------------
  ステップ名: [ (テキスト入力) ]
  タイプ:     [ シェルコマンド v]
  ターゲット: [ (テキスト入力) ]
  ...
  [↑] [↓] [削除]

 [ステップ2] --------------------------------------------------------
 ...

----------------------------------------------------------------------
                                                 [ ステップを追加 ]
======================================================================
                                       [ 保存 ] [ キャンセル ]
======================================================================
```

-----

### 5. MVP（Minimum Viable Product）のスコープ

最初のリリースでは、以下のコア機能の実装を優先する。

*   **ワークフローの定義:** 上記UIによるワークフローとステップのCRUD。
*   **順次実行:** ステップを`step_order`に従って順番に実行する機能。
*   **基本的なエラーハンドリング:** `on_failure: stop` のみを実装し、ステップが失敗したらワークフロー全体を`FAILED`として停止する。
*   **ログ記録:** ワークフロー全体の実行状態（`workflow_runs`）と、各ステップの実行ログ（`ProcessExecutionLog`）を記録する。
*   **排他制御:** `max_instances=1` を利用し、同一ワークフローの多重起動を防止する。

### 6. 今後の拡張機能

以下の高度な機能は、MVPのリリース後、必要に応じて追加開発を行う。

*   **ステップ間のデータ受け渡し:** あるステップの出力（`stdout`など）を、後続のステップの引数として利用する機能。（例: `{{steps.step1.stdout}}`）
*   **パラメータ化:** ワークフロー実行時に外部から引数を渡す機能。
*   **高度なエラーハンドリング:** `on_failure: continue` の実装。
*   **リトライ処理:** 失敗したステップを自動的にリトライする機能。

-----