# 機能拡張: シェルコマンドジョブにおけるCWDサポート

## 1. 目的

現在のタスクスケジューラは、`shell_command` タイプのジョブを通じて外部コマンドを実行できますが、コマンドの作業ディレクトリ（Current Working Directory, CWD）を指定する機能がありません。

このドキュメントでは、`cwd` パラメータをジョブ定義に追加し、特定のディレクトリでコマンドを実行できるようにする機能拡張について説明します。これにより、以下のような、より複雑なユースケースに対応できるようになります。

*   特定のGitリポジトリ内で `git pull` を実行する。
*   特定のディレクトリに存在する設定ファイルや入力データに依存するスクリプトを実行する。
*   生成物の出力先を制御する。

## 2. 提案された解決策

この機能を実現するために、アプリケーションの複数のレイヤーにわたる変更が必要です。

### 2.1. 修正対象ファイルと変更概要

1.  **`src/modules/scheduler/schemas.py`**
    *   `JobConfig` モデルに `cwd: Optional[str] = None` フィールドを追加します。これにより、APIやWeb UIから `cwd` を受け取れるようになります。

2.  **`src/modules/scheduler/models.py`**
    *   `JobDefinition` SQLAlchemyモデルに `cwd = Column(String, nullable=True)` を追加します。これにより、`cwd` をデータベースに永続化します。

3.  **`src/modules/scheduler/service.py`**
    *   `JobDefinitionCRUD` クラスで、`JobConfig` から `JobDefinition` モデルへのマッピング処理に `cwd` を含めるように修正します。

4.  **`src/modules/scheduler/loader.py`**
    *   `apply_job_config`: スケジューラにジョブを追加する際、`cwd` が指定されていれば、それをジョブのキーワード引数として渡すようにします。
    *   `seed_db_from_yaml`: `jobs.yaml` からデータベースを初期化する際に、`cwd` フィールドを `JobDefinition` モデルに含めるようにします。

5.  **`src/modules/scheduler/job_executors.py`**
    *   `execute_shell_command` 関数のシグネチャを `cwd` パラメータを受け取れるように変更します。
    *   `subprocess.run` を呼び出す際に、受け取った `cwd` を渡します。

## 3. 使用例

この変更により、`jobs.yaml` やWeb UIで以下のように `cwd` を指定したジョブを定義できるようになります。

**例: `jobs.yaml` でGitリポジトリを更新するジョブを定義**

```yaml
- id: "update-my-project-repo"
  func: "git"
  description: "プロジェクトのリポジトリをプルして最新の状態に更新します。"
  job_type: "shell_command"
  trigger:
    type: "cron"
    hour: "3" # 毎日午前3時に実行
  args:
    - "pull"
  # ここで作業ディレクトリを指定
  cwd: "C:\\Users\\xzyoi\\Desktop\\projects\\my-project"
  is_enabled: true
```

## 4. 注意事項

`cwd` パラメータを使用する際には、以下の点に特に注意してください。

*   **パスの形式**:
    *   `cwd` に指定するパスは、スケジューラが動作しているマシンから見た**絶対パス**である必要があります。相対パスを指定した場合、意図しないディレクトリでコマンドが実行される可能性があるため、サポートされません。

*   **アクセス権限**:
    *   スケジューラを実行しているユーザー（またはサービスアカウント）が、`cwd` で指定されたディレクトリに対する**読み取り権限**および**実行権限**を持っている必要があります。権限が不足している場合、ジョブは失敗します。

*   **セキュリティ**:
    *   ユーザーが指定した任意のコードやコマンドを実行させることになるため、セキュリティには最大限の注意が必要です。信頼できないスクリプトやコマンドを実行するためにこの機能を使用しないでください。
    *   Web UIなどを通じてユーザーが `cwd` を自由に設定できる場合、システムの重要なディレクトリ（例: `C:\Windows`）が指定される可能性も考慮し、入力値の検証や機能へのアクセス制限を検討することが強く推奨されます。
    *   より高度な対策として、実行できるファイルの置き場所を特定のディレクトリに限定したり、コンテナ技術などを利用してサンドボックス環境でジョブを実行するなどのアーキテクチャも考えられます。

*   **環境変数**:
    *   `cwd` を指定して実行されるコマンドの環境変数は、ユーザーがインタラクティブにシェルを起動した場合とは異なる可能性があります。スクリプトが特定の環境変数に依存している場合は、その点を考慮する必要があります。

## 5. アーキテクチャに関する補足

ご指摘いただいた重要な考慮点について、現在のシステムの設計状況を補足します。

*   **永続化 (Persistence)**:
    *   現在のシステムは、ジョブ定義をSQLiteデータベースに永続化しています。`JobDefinition` モデルと `SQLAlchemy` の利用により、Web UIやAPI経由で動的に追加・変更されたジョブはアプリケーションを再起動しても失われず、スケジュール通りに実行が継続されます。

*   **スケジューラオブジェクトへのアクセス (Scheduler Access)**:
    *   システムは `src/modules/scheduler/scheduler_instance.py` を通じて、スケジューラの単一のインスタンス（シングルトン）を管理しています。これにより、APIエンドポイント、バックグラウンド処理、設定ローダーなど、アプリケーションのどこからでも一貫したスケジューラオブジェクトにアクセスできる設計が採用されています。




