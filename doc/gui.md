# Web GUI設計書 

本文書は、`basic_design.md`、`process.md`、`enhancement.md`、および`jobs.yaml`の仕様に基づき、タスクスケジューラ管理用Web GUIに必要な要素と画面レイアウトを定義する。

## 1. 全体的なコンセプトと採用技術

- **目的**: スケジュールされたジョブ、ワークフロー、および実行履歴を視覚的に管理し、直感的な操作を提供する。
- **採用フレームワーク**: `gui.md`の提案に基づき、迅速な開発とデータ可視化に優れた**Streamlit**を推奨する。
- **アーキテクチャ**: GUIはバックエンドのREST API（FastAPI）と通信するクライアントとして機能する。状態の永続化はAPIを介してデータベース（SQLite/PostgreSQL）で行われる。

---

## 2. 画面全体の共通レイアウト

- **ナビゲーション**: 画面の**左側にサイドバー**を常に表示し、各画面へのリンクを配置する。
  - ダッシュボード
  - ジョブ管理
  - ワークフロー管理
  - 設定

---

## 3. 主要な画面コンポーネントとレイアウト案

### 3.1. ダッシュボード (メイン画面)

システムの全体像と時間の流れを把握するための初期画面。

- **【レイアウト案】**
  - **上段**: 「サマリーカード」を配置する。
  - **中段**: 「今後のジョブと最近のジョブのタイムライン」を配置する。
  - **下段**: 「システム状態」を表示する。

- **システム状態**:
  - スケジューラエンジン（APScheduler）の稼働状態（`RUNNING`, `PAUSED`, `STOPPED`）。
  - `jobs.yaml`のホットリロード監視の状態。

---

### 3.2. サマリーカード
ダッシュボード上部に配置され、最も重要な4つの指標をカード形式で表示します。

*   **Total Jobs (総ジョブ数)**:
    *   **表示内容**: システムに登録されている全てのジョブの総数。
    *   **数値例**: 872,000
*   **Running Jobs (実行中ジョブ数)**:
    *   **表示内容**: 現在実行中のジョブの数。
    *   **数値例**: 58,000
*   **Next Scheduled Job (次のスケジュール)**:
    *   **表示内容**: 次に実行がスケジュールされているジョブの数（または時刻）。
    *   **数値例**: 88,000
*   **Last Failed Job (最終失敗ジョブ)**:
    *   **表示内容**: 直近で失敗したジョブの数（または時刻）。
    *   **数値例**: 40,000

### 3.3. 今後のジョブと最近のジョブのタイムライン (Upcoming & Recent Job Timeline)
ジョブの実行状況を時系列で視覚的に表示するエリアです。`vis.js`ライブラリを使用し、視覚的に分かりやすいインタラクティブなタイムラインを提供します。

*   **表示形式**: 左から右へ時間が流れる水平のタイムライン。ジョブが密集している場合でも視認性を保つため、タイムラインの上下に交互にジョブが表示されます。
*   **表示要素**:
    *   **ステータス**: 各ジョブは現在の状態（例: Completed, Scheduled, Failed）によって色分けされたタグで表示されます。
    *   **ジョブ情報**: ジョブ名（例: Job A）、実行時刻（例: 7:00 AM）、現在実行中かどうかの情報（Current）が表示されます。
    *   **時間軸**: 過去から現在（NOW）までの流れを示します。

#### 3.3.1. タイムライン表示の改善案 (スケーラビリティとUX向上)

現在のデザインを維持しつつ、大量のジョブや長期間の表示に対応するための改善案を以下に示す。これらの機能は`vis.js`の強力な機能を利用して実装される。

*   **対策1：フィルタリング機能の追加**
    *   **概要**: ユーザーが見たい情報だけを表示できるように、タイムラインにフィルタリング機能を追加する。
    *   **機能**: 
        *   **ステータスフィルタ**: 「全て」「実行中」「完了」「失敗」「今後」などのステータスでジョブを絞り込む。
        *   **ジョブID/名称フィルタ**: ジョブID、ジョブ名、または説明に含まれるキーワードでジョブを検索し、表示を絞り込む。
    *   **効果**: 表示件数を絞り込むことで、横スクロールの量を抑制し、特定の関心事に対する視認性を向上させる。

*   **対策2：時間軸のズーム機能**
    *   **概要**: タイムラインの表示スケールを動的に変更できるズーム機能を追加する。
    *   **機能**: 
        *   **ズームレベル選択**: 「日」「時間」「分」単位での表示を切り替えるドロップダウンセレクタを提供。
        *   **インタラクティブズーム**: マウスホイールやピンチ操作による直感的なズームイン・ズームアウトに対応。
    *   **効果**: 全体像の把握と詳細な状況確認をスムーズに行き来できるようにし、UXを向上させる。

*   **対策3：ジョブのグルーピング（クラスタリング）**
    *   **概要**: 短時間に多数のジョブが集中している場合、それらを視覚的に一つのグループとしてまとめる。
    *   **機能**: 
        *   **自動クラスタリング**: 設定された時間範囲（例: 10分以内）に複数のジョブが存在する場合、それらを自動的に一つのクラスターとして表示する。
        *   **クラスター表示**: 「HH:MM - HH:MM (X件のジョブ)」のように、クラスター内の最初と最後のジョブの時刻とジョブ数を表示。
        *   **詳細展開**: クラスターをクリックすると、ズームインして個々のジョブの詳細を表示する。
    *   **効果**: 密集した情報を整理し、タイムラインの視認性を高め、ユーザーが重要な情報に素早くアクセスできるようにする。横方向の表示領域を効率的に利用し、スクロールバーの発生を抑制する。

*   **対策4：レスポンシブ対応**
    *   **概要**: 画面幅が狭いデバイス（スマートフォンなど）でもタイムラインが適切に表示されるように対応する。
    *   **機能**: 
        *   `vis.js`のレスポンシブ機能を活用し、画面サイズに応じてタイムラインの表示を最適化する。
        *   極端に狭い画面幅の場合、タイムラインの高さや表示される情報量を調整し、簡易的な表示に切り替えることを検討する。
    *   **効果**: あらゆるデバイスで一貫したユーザーエクスペリエンスを提供する。

---

### 3.4. ジョブ管理画面

すべてのジョブを一覧し、管理するための画面。

- **【レイアウト案】**
  - **画面上部**: 画面の横幅いっぱいに「フィルタリングと検索」エリアを配置。
  - **画面右上**: 「新規ジョブ作成」ボタンを配置。
  - **メインエリア**: 「ジョブ一覧テーブル」を配置する。テーブルの各行の右端に「操作」ボタン群をまとめる。

- **フィルタリングと検索**:
  - ジョブ名やIDで一覧を検索する機能。
  - ステータス（有効、無効、失敗など）でフィルタリングする機能。
- **一括操作**:
  - テーブルの各行の先頭にチェックボックスを配置。複数選択して一括で有効化/無効化/削除する。
- **ジョブ一覧テーブル**:
  - **表示項目**: `ID`, `有効/無効` (トグルスイッチ), `ジョブ名/Func`, `スケジュール (Trigger)`, `次の実行時刻`, `前回の実行結果` (アイコン)。
  - **操作**: `手動実行`, `一時停止/再開`, `編集`, `削除`の各ボタン。

---

### 3.5. ジョブ作成・編集フォーム

`jobs.yaml`のスキーマに基づいた、ジョブを定義するためのフォーム。

- **【レイアウト案】**
  - ジョブ管理画面の「新規作成」または「編集」ボタンクリック時に、**モーダルダイアログ (`st.dialog`)** として画面中央に表示する。
  - フォーム内は「基本情報」「トリガー設定」などのセクションごとに見出しで区切る。
  - `トリガー設定`では、`type`のドロップダウン選択に応じて、表示される入力フィールドが動的に切り替わるようにする。
  - フォーム下部に`保存`と`キャンセル`ボタンを横並びに配置する。

- **フォーム項目**: (※元の設計書通り)
  - **基本情報**: `id`, `func`
  - **トリガー設定 (Trigger)**: `type`, `cron` / `interval` の各フィールド
  - **実行引数**: `args`, `kwargs`
  - **高度な設定**: `replace_existing`, `max_instances`, etc.
  - **アクション**: `保存`, `キャンセル`

---

### 3.6. ジョブ詳細・実行履歴画面

特定のジョブの詳細情報と、その実行履歴を表示する画面。

- **【レイアウト案】**
  - 画面を上下2段に分割する。
  - **上段**: 「ジョブ定義詳細」を読み取り専用のフォーム形式で表示する。
  - **下段**: 「実行履歴テーブル」を配置する。
  - **ログ表示**: 実行履歴テーブルで行を選択すると、テーブルの下またはモーダルで「ログ表示エリア」が表示される。

- **ジョブ定義詳細**:
  - 作成・編集フォームの内容を読み取り専用で表示。
- **実行履歴テーブル**:
  - **表示項目**: `実行ID`, `ステータス`, `開始時刻` / `終了時刻`, `実行時間`。
  - **操作**: `ログ表示`ボタン。
- **ログ表示エリア**:
  - 選択されたジョブのログ（`stdout`, `stderr`）を表示。
  - `ログをコピー`ボタンをエリア右上に配置。

---

### 3.7. ワークフロー管理画面 (拡張機能)

- **【レイアウト案】**
  - 画面を左右2カラムに分割する。
  - **左カラム**: 「ワークフロー一覧」をリスト形式で表示。
  - **右カラム**: 左カラムで選択されたワークフローの「作成・編集フォーム」と「ワークフロー可視化」エリアを表示する。

- **ワークフロー一覧**:
  - 定義済みのワークフローをリスト表示。
- **ワークフロー作成・編集フォーム**:
  - `name`, `description`, ステップ定義エリア。
- **ワークフロー可視化**:
  - ステップ間の依存関係をグラフ形式で表示。

---

### 3.8. 設定画面

- **【レイアウト案】**
  - 画面上部に**タブ**を配置し、「`jobs.yaml`の管理」「スケジューラ制御」「通知設定」を切り替えて表示する。

- **`jobs.yaml`の管理タブ**:
  - 現在の`jobs.yaml`の内容を表示するエディタ。
  - `jobs.yaml`をアップロードするファイルアップローダーと「適用」ボタン。
- **スケジューラ制御タブ**:
  - スケジューラ全体の一時停止/再開/シャットダウンを行うボタンを配置。
- **通知設定タブ**:
  - ジョブの成功/失敗時のデフォルト通知先を設定するフォーム。