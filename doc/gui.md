# Web GUI設計書

本文書は、`basic_design.md`、`process.md`、`enhancement.md`、および`jobs.yaml`の仕様に基づき、タスクスケジューラ管理用Web GUIに必要な要素を定義する。

---

## 1. 全体的なコンセプトと採用技術

- **目的**: スケジュールされたジョブ、ワークフロー、および実行履歴を視覚的に管理し、直感的な操作を提供する。
- **採用フレームワーク**: `gui.md`の提案に基づき、迅速な開発とデータ可視化に優れた**Streamlit**を推奨する。
- **アーキテクチャ**: GUIはバックエンドのREST API（FastAPI）と通信するクライアントとして機能する。状態の永続化はAPIを介してデータベース（SQLite/PostgreSQL）で行われる。

---

## 2. 主要な画面コンポーネントと要素

### 2.1. ダッシュボード (メイン画面)

システムの全体像を把握するための初期画面。

- **サマリービュー**:
    - **現在のジョブ数**: スケジュールされているジョブの総数。
    - **実行中ジョブ**: 現在アクティブなジョブの数とリスト。
    - **次の実行予定**: 直近に実行が予定されているジョブのリスト（ジョブ名、実行時刻）。
    - **最新の失敗ジョブ**: 最近失敗したジョブのリスト（ジョブ名、失敗時刻、エラー概要）。
- **カレンダービュー**:
    - `streamlit-calendar`のようなコンポーネントを利用。
    - 日付ごとにスケジュールされているジョブを視覚的に表示。
    - ジョブの状態（成功、失敗、実行中、予定）に応じて色分け。
    - 日付をクリックすると、その日にスケジュールされているジョブの一覧を表示、または新規ジョブ作成フォームへ遷移。
- **システム状態**:
    - スケジューラエンジン（APScheduler）の稼働状態（`RUNNING`, `PAUSED`, `STOPPED`）。
    - `jobs.yaml`のホットリロード監視の状態。

### 2.2. ジョブ管理画面

すべてのジョブを一覧し、管理するための画面。

- **ジョブ一覧テーブル**:
    - **表示項目**:
        - `ID`: ジョブの一意なID。
        - `有効/無効`: ジョブの実行を制御するトグルスイッチ。
        - `ジョブ名/Func`: `id`または`func`のパス。
        - `スケジュール (Trigger)`: `cron`や`interval`の概要（例: `Cron: 0 8 * * 1-5`）。
        - `次の実行時刻`: `next_run_time`。
        - `前回の実行結果`: 成功/失敗のアイコン表示。
    - **操作**:
        - `手動実行`: ジョブを即時実行するボタン。
        - `一時停止/再開`: ジョブのスケジュールを一時停止/再開するボタン。
        - `編集`: ジョブ編集フォームへ遷移するボタン。
        - `削除`: ジョブを削除するボタン（確認ダイアログ付き）。
- **フィルタリングと検索**:
    - ジョブ名やIDで一覧を検索する機能。
    - ステータス（有効、無効、失敗など）でフィルタリングする機能。
- **一括操作**:
    - 複数のジョブを選択して一括で有効化/無効化/削除する機能。

### 2.3. ジョブ作成・編集フォーム

`jobs.yaml`のスキーマに基づいた、ジョブを定義するためのフォーム。モーダルウィンドウまたは専用ページとして実装。

- **基本情報**:
    - `id` (必須, 文字列): ジョブの一意な識別子。
    - `func` (必須, 文字列): 実行する関数の完全修飾パス（例: `scheduler.tasks.sample_tasks.my_task`）。
- **トリガー設定 (Trigger)**:
    - `type` (必須, ドロップダウン): `cron` / `interval` / `date` から選択。
    - **`cron`選択時のフィールド**:
        - `day_of_week`: (例: `mon-fri`, `0-4`)
        - `hour`: (例: `8`, `*/2`)
        - `minute`: (例: `0`, `30`)
        - `timezone`: (ドロップダウン, 例: `Asia/Tokyo`, `UTC`)
    - **`interval`選択時のフィールド**:
        - `weeks`, `days`, `hours`, `minutes`, `seconds` (数値入力)。
- **実行引数**:
    - `args` (リスト): 動的に追加・削除可能なテキスト入力フィールド。
    - `kwargs` (辞書): 動的に追加・削除可能なキーと値のペア入力フィールド。
- **高度な設定**:
    - `replace_existing` (チェックボックス): デフォルトで`True`を推奨。
    - `max_instances` (数値入力): 同時実行インスタンス数の上限。
    - `coalesce` (チェックボックス): ジョブ実行が重なった場合の挙動。
    - `misfire_grace_time` (数値入力): 実行遅延の許容時間（秒）。
- **アクション**:
    - `保存`ボタン: ジョブを保存または更新する。
    - `キャンセル`ボタン: 変更を破棄して閉じる。

### 2.4. ジョブ詳細・実行履歴画面

特定のジョブの詳細情報と、その実行履歴を表示する画面。

- **ジョブ定義詳細**:
    - 作成・編集フォームの内容を読み取り専用で表示。
- **実行履歴テーブル**:
    - **表示項目**:
        - `実行ID`: 実行ごとの一意なID。
        - `ステータス`: `SUCCESS`, `FAILED`, `RUNNING`。
        - `開始時刻` / `終了時刻`。
        - `実行時間`。
    - **操作**:
        - `ログ表示`: 各実行の標準出力/標準エラー出力を表示するボタン。
- **ログ表示エリア**:
    - 実行履歴で選択されたジョブのログ（`stdout`, `stderr`）をリアルタイムまたは完了後に表示。
    - ログのコピーボタン。

### 2.5. ワークフロー管理画面 (拡張機能)

`basic_design.md`で定義されたシナリオ（ワークフロー）を管理するための画面。

- **ワークフロー一覧**:
    - 定義済みのワークフローをリスト表示。
- **ワークフロー作成・編集フォーム**:
    - `name`, `description`。
    - **ステップ定義エリア**:
        - 既存のジョブをドラッグ＆ドロップやリスト選択で順序付けて追加。
        - 各ステップのエラーハンドリング設定（`on_fail`: `stop`, `continue`など）。
- **ワークフロー可視化**:
    - ステップ間の依存関係をグラフ形式で表示。

### 2.6. 設定画面

- **`jobs.yaml`の管理**:
    - 現在の`jobs.yaml`の内容を表示するエディタ。
    - `jobs.yaml`をサーバーにアップロードしてホットリロードをトリガーする機能。
- **スケジューラ制御**:
    - スケジューラ全体の一時停止/再開/シャットダウン。
- **通知設定**:
    - ジョブの成功/失敗時のデフォルト通知先（Emailなど）を設定。