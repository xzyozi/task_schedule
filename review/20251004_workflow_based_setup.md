# コードレビュー：既存ワークフローシステムを利用したプロジェクトセットアップ

**日付：** 2025-10-04

## 1. 概要

このレビューは、`doc/workflow.md`で定義されている既存のワークフローシステムを使用して、Gitリポジトリからのプロジェクトセットアップを自動化することの実現可能性を評価するものです。

**結論：** 既存のワークフローシステムは、このユースケースに対して**強力だが不完全な基盤**を提供します。シェルコマンドを順次実行するという中核的なコンセプトは、ニーズに完全に合致しています。しかし、これを真に実用的でユーザーフレンドリーな機能にするためには、仕様書に記載されている設計には対処すべき重大なギャップが存在します。提案されているシナリオは、いくつかの重要な詳細が実装されることを前提として、**条件付きで実現可能**です。

---

## 2. `workflow.md`に基づく分析

複数ステップのワークフロー（`git clone` -> `pip install` -> `run`）を作成するという提案シナリオを、仕様書と照らし合わせて評価します。

### 2.1. 利点（うまく機能する点）

- **順次実行:** `step_order`の仕組みは、`pip install`が開始される前に`git clone`が完了することを保証するのに理想的です。
- **コマンド実行:** `job_type`が`shell`、`cmd`、`powershell`をサポートしていることは、必要な外部コマンド（`git`, `python`, `pip`）を実行するためにまさに求められているものです。
- **UI駆動の定義:** 仕様書に記述されているUI設計により、ユーザーは設定ファイルを編集することなくこれらのステップを定義でき、ユーザーフレンドリーです。

### 2.2. ギャップと必要な前提条件（実装または明確化が必要な点）

仕様書に基づき、以下のギャップと、実装が必要な詳細が特定されました。

1.  **重大なギャップ：パラメータ化の欠如**
    - `workflow.md`のドキュメントでは、「パラメータ化」（実行時に引数を渡すこと）が**将来の拡張機能**であると明記されています。これが最も重大な制約です。
    - **影響：** これがないと、ユーザーはワークフローステップの`target`フィールドに**GitリポジトリのURLをハードコーディングする**必要があります。これは、ユーザーがセットアップしたいプロジェクトごとに、全く新しい別のワークフローを作成しなければならないことを意味します。これにより、汎用的で再利用可能な「プロジェクトセットアップ」ワークフローの作成が妨げられます。

2.  **暗黙の要件：ワーキングディレクトリ（`cwd`）の管理**
    - 仕様書では、シェルコマンドのワーキングディレクトリがどのように管理されるか定義されていません。このシナリオが機能するためには、`run_workflow`ジョブ実行機能が以下のロジックを実行するように**実装されなければなりません**。
        - ワークフローの実行ごとに、ワーキングディレクトリのパス（例：`~/.task_scheduler/<workflow_name>`）を決定する。
        - このディレクトリが存在しない場合は作成する。
        - そのワークフローの全ての`shell`/`cmd`ステップを、この特定のディレクトリ内で実行する（つまり、`subprocess`呼び出しに`cwd`引数を渡す）。

3.  **曖昧さ：長時間実行プロセスの扱い**
    - シナリオの最終ステップはサーバーを起動することですが、これは長時間実行され、終了しないプロセスです。
    - `run_workflow`実行機能はステップを順次実行すると記述されていますが、次のステップを開始する前に、あるステップのプロセスが終了するのを待つかどうかは不明確です。もし待つ仕様であれば、「アプリケーションの起動」ステップでワークフローは無期限にハング（停止）してしまいます。
    - **解決策：** 実行機能にこれを処理する仕組みを持たせるか、シナリオで記述されているように、バックグラウンドプロセスを起動するためのプラットフォーム固有のコマンド（Windowsの`start`やLinuxの`&`など）を使用するようユーザーに指示する必要があります。

---

## 3. 実現可能性と推奨事項

提案されているシナリオは実現可能ですが、そのユーザビリティはパラメータ化の欠如によって著しく損なわれています。

- **短期的な推奨事項（回避策）：**
    1.  **`cwd`ロジックの実装：** 上記で説明したワーキングディレクトリ管理を`run_workflow`実行機能内に実装することを最優先します。これは不可欠です。
    2.  **プロセス処理の明確化：** 長時間実行プロセスがどのように扱われるかを文書化、または実装します。
    3.  **ユーザー向けドキュメント：** 上記が実装されれば、この機能をリリースできます。ユーザードキュメントには、プロジェクトごとに新しいワークフローを作成し、GitのURLをハードコーディングする必要があることを明確に記載しなければなりません。

- **長期的な推奨事項（本質的な解決策）：**
    1.  **パラメータ化の実装：** この機能を真に強力で再利用可能なものにするための最優先事項は、`workflow.md`で将来の拡張機能として言及されている「パラメータ化」機能を実装することです。これにより、ユーザーは汎用的な「プロジェクトセットアップ」ワークフローを選択し、実行時にGitのURLを引数として渡すだけで済むようになります。

このアプローチは、要求通りに既存のアーキテクチャを活用し、限定的だが機能的な初期実装から、より堅牢でユーザーフレンドリーな最終的な機能への明確な道筋を示します。